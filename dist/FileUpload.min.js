/*!
 * h5-file-upload v1.0.2
 * (c) 2017-2018 penyuying
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.FileUpload={})}(this,function(e){"use strict";function t(e,t){if(e){this._el=e;var i={fileKey:null,fileTypeExts:"*.jpg;*.png;*.gif;*.jpeg",uploader:"",auto:!0,async:!0,submitUpload:!0,method:"post",multi:!0,formData:null,dataType:"",fileObjName:"file",fileSizeLimit:10240,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"\u9009\u62e9\u6587\u4ef6",compressWidth:1920,compressHeight:1920,compressTotal:0,compressMinSize:100,compressBg:"rgba(0, 0, 0, 0)",encoderOptions:.8,tile:1e6,removeTimeout:1e3,itemTemplate:"",onReaderFile:null,onUploadStart:null,onProgress:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onCompressStart:null,onCompress:null,onSizeError:null,onFileTypeError:null,onInit:null,onCancel:null};(this._options=o(i,t)).el=e,this._init()}}function i(e,t){try{return new Blob(e,{type:t})}catch(n){var i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);return e.forEach(function(e){i.append(e)}),i.getBlob(t)}}function n(){return~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534?new function(){var e=this,t=[],n=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),o=XMLHttpRequest.prototype.send;this.append=function(e,i,o){t.push("--"+n+'\r\nContent-Disposition: form-data; name="'+e+'"'),i instanceof Blob?(t.push('; filename="'+(o||"blob")+'"\r\nContent-Type: '+i.type+"\r\n\r\n"),t.push(i)):t.push("\r\n\r\n"+i),t.push("\r\n")},XMLHttpRequest.prototype.send=function(a){var r=void 0,l=void 0,s=this;a===e?(t.push("--"+n+"--\r\n"),l=i(t),(r=new FileReader).onload=function(){o.call(s,r.result)},r.onerror=function(e){throw e},r.readAsArrayBuffer(l),this.setRequestHeader("Content-Type","multipart/form-data; boundary="+n),XMLHttpRequest.prototype.send=o):o.call(this,a)}}:new FormData}function o(e,t){if(e=e||{},!t)return e;for(var i in t)e[i]instanceof Object?o(e[i],t[i]):e[i]=t[i];return e}function a(e,t){return e=e>1048576&&!t?(Math.round(100*e/1048576)/100).toString()+"MB":(Math.round(100*e/1024)/100).toString()+"KB"}function r(e){for(var t=[],i=e.split(";"),n=0,o=i.length;n<o;n++){var a=i[n].split(".").pop();a&&t.push(a.toLowerCase())}return t}t.prototype={_init:function(){var e=this,t=e._options,i=e._el;e._files=null;var n=e._fileObj=e._addFileBtn(i)||{};n.fileInput&&n.fileInput.addEventListener("change",function(t){e._funGetFiles(t)}),t.onInit&&t.onInit instanceof Function&&t.onInit&&t.onInit({el:i,fileKey:t.fileKey})},_fileReader:function(e,t){var i=this,n=i._options,o=e.name.split(".").pop();if(!o||i._inArray(o.toLowerCase(),["jpg","jpeg","png","gif","bmp","jpe"])<0||!n.compressMinSize||e.size<=1024*n.compressMinSize)return i._funUploadFile(e,t),e;var a=new FileReader;a.onload=function(){function n(){var n=i._compress(a,e.type,t,e);n=i._toBuffer(n,e.type,e.name),i._funUploadFile(n,t),a=null}var o=this.result,a=new Image;a.src=o,a.complete?n():a.onload=n},a.readAsDataURL(e)},_addFileBtn:function(e){var t=this._options;if(e){var i=function(e){var t=[];if(e&&e.length>0)for(var i=0;i<e.length;i++){var n=function(e){var t="";if(!e)return t;switch(e=(e+"").replace(/\*|\.|\s+/g,"").toLowerCase()){case"3gpp":t="audio/3gpp,video/3gpp";break;case"ac3":t="audio/ac3";break;case"asf":t="allpication/vnd.ms-asf";break;case"au":t="audio/basic";break;case"css":t="text/css";break;case"csv":t="text/csv";break;case"rtf":t="application/rtf,text/rtf";break;case"htm":case"html":t="text/html";break;case"xhtml":t="application/xhtml+xml";break;case"js":t="text/javascript,application/javascript";break;case"txt":t="text/plain";break;case"xml":t="text/xml,application/xml";break;case"dwg":t="image/vnd.dwg";break;case"dxf":t="image/vnd.dxf";break;case"gif":t="image/gif";break;case"jp2":t="image/jp2";break;case"jpe":case"jpeg":case"jpg":t="image/jpeg";break;case"png":t="image/png";break;case"svf":t="image/vnd.svf";break;case"tif":case"tiff":t="image/tiff"}return t}(e[i]);n&&t.push(n)}return t.length<=0?t.push("*"):t.push("image/*"),t}(r(t.fileTypeExts));i=i&&i.join(",")||"*";var n=function(e,t){var i=document.createDocumentFragment(),n=document.createElement("div");i.appendChild(n),n.innerHTML=e;for(var o=n.childNodes||[],a=0;a<o.length;a++)i.appendChild(o[a]);return i.removeChild(n),i}('<div style="display:inline-block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;overflow: hidden;">\n                    <span class="_select-btn-text_" style="display:inline-block;width:100%;line-height:50px;text-align:center;font-size: 12px;color:#999999;">'+t.buttonText+'</span>\n                    <input class="_select-file-btn_"\n                    style="display:block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;font-size: 1000000px;filter: alpha(opacity=0);opacity: 0;"\n                    '+(t.multi?" multiple":"")+'\n                    type="file" name="fileselect" accept="'+i+'">\n                </div>'),o=n.querySelectorAll("input"),a=n.querySelectorAll("div");return e.style.position="relative",e.appendChild(n),{fileInputWrap:a&&a[0]||null,fileInput:o&&o[0]||null}}},_filter:function(e){var t=[],i=this._options,n=r(i.fileTypeExts);if(n.length>0)for(var o=0,l=e.length;o<l;o++){var s=e[o];parseInt(a(s.size,!0))>i.fileSizeLimit?i.onSizeError instanceof Function&&i.onSizeError({el:this._el,fileKey:i.fileKey,index:o,fileName:s.name,file:s,maxSize:a(1024*i.fileSizeLimit||0,!0),size:a(s.size,!0)}):this._inArray(s.name.split(".").pop(),n)>=0?t.push(s):i.onFileTypeError&&i.onFileTypeError instanceof Function&&i.onFileTypeError({el:this._el,fileKey:i.fileKey,index:o,fileName:s.name,file:s,type:s.name.split(".").pop(),typeArray:n})}return t},_inArray:function(e,t){var i=-1;if(!e||!t||t.length<=0)return-1;"string"==typeof e&&(e=e.toLowerCase());for(var n=0;n<t.length;n++){var o=t[n];if("string"==typeof o&&(o=o.toLowerCase()),e==o){i=n;break}}return i},_funGetFiles:function(e){var t=this._options,i=e.target.files;t.onReaderFile instanceof Function&&t.onReaderFile({el:this._el,fileKey:t.fileKey,files:i}),i=this._filter(i),this._files=i,this.submitUpload()},submitUpload:function(){for(var e=this._files,t=this._options,i=0,n=e.length;i<n;i++){var o=e[i];t.auto&&(this._execUpload(o,i),this._files=null)}},_execUpload:function(e,t){var i=this;try{i._fileReader(e,t)}catch(n){i._funUploadFile(e,t)}},_getRatio:function(e,t,i){var n=e/(i.compressWidth>0&&i.compressWidth||e)||0,o=t/(i.compressHeight>0&&i.compressHeight||t)||0,a=Math.sqrt(e*t/(i.compressTotal>0&&i.compressTotal||e*t))||1;return Math.max(Math.max(n,o)||0,a)||1},_compress:function(e,t,i,n){var o=this._options,a=e.src.length,r=e.width,l=r,s=e.height,p=s,f=1,c=0,d=document.createElement("canvas"),u=d.getContext("2d"),h=document.createElement("canvas"),m=h.getContext("2d");(c=this._getRatio(l,p,o))>1&&(r/=f=c,s/=f),o.onCompressStart&&o.onCompressStart instanceof Function&&o.onCompressStart({el:this._el,fileKey:o.fileKey,index:i,file:n,size:a,width:l,height:p,compressWidth:r,compressHeight:s,ratio:f}),d.width=r,d.height=s,u.fillStyle=o.compressBg||"rgba(255, 255, 255, 0)",u.fillRect(0,0,d.width,d.height);var g=void 0;if((g=r*s/(o.tile||1e6))>1){var v=~~(r/(g=~~(Math.sqrt(g)+1))),y=~~(s/g);h.width=v,h.height=y;for(var _=0;_<g;_++)for(var b=0;b<g;b++)m.drawImage(e,_*v*f,b*y*f,v*f,y*f,0,0,v,y),u.drawImage(h,_*v,b*y,v,y)}else u.drawImage(e,0,0,r,s);var x=d.toDataURL(t||"image/png",o.encoderOptions||.6);return o.onCompress&&o.onCompress instanceof Function&&o.onCompress({el:this._el,fileKey:o.fileKey,index:i,file:n,base64Data:x,currentSize:x.length,size:a,ratio:~~(100*(a-x.length)/a)+"%",width:l,height:p,compressWidth:r,compressHeight:s}),h.width=h.height=d.width=d.height=0,x},_toBuffer:function(e,t,n){for(var o=window.atob(e.split(",")[1]),a=new Uint8Array(o.length),r=0;r<o.length;r++)a[r]=o.charCodeAt(r);var l=i([a],t);return l.name=n||"",l},_onProgress:function(e,t,i,n){var o=this._options;o.onProgress&&o.onProgress instanceof Function&&o.onProgress({el:this._el,fileKey:o.fileKey,index:e,file:t,loaded:i,total:n})},_funUploadFile:function(e,t){var i=this,o=function(){var e=void 0;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){e=new ActiveXObject("Microsoft.XMLHTTP")}}return e}()||!1,a=i._options,r=i._fileObj;if(i._files=null,o&&o.upload){o.upload.addEventListener("progress",function(n){i._onProgress(t,e,n.loaded,n.total)},!1),o.onreadystatechange=function(n){if(4==o.readyState){if(200==o.status){var l=o.responseText;"json"==a.dataType&&(l=JSON.parse(o.responseText)),a.onUploadSuccess&&a.onUploadSuccess({el:i._el,fileKey:a.fileKey,file:e,index:t},l)}else a.onUploadError&&a.onUploadError({el:i._el,fileKey:a.fileKey,file:e,index:t},o);a.onUploadComplete&&a.onUploadComplete({el:i._el,fileKey:a.fileKey,file:e,index:t},o),r.fileInput.value=""}},a.onUploadStart&&a.onUploadStart({el:i._el,fileKey:a.fileKey,file:e,index:t,fileName:e.name}),o.open(a.method,a.uploader,a.async||!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest");var l=n();if(e.name?l.append(a.fileObjName,e,e.name):l.append(a.fileObjName,e),a.formData)for(var s in a.formData)l.append(s,a.formData[s]);o.send(l)}}};var l=t;e.FileUpload=l,Object.defineProperty(e,"__esModule",{value:!0})});