/*!
 * h5-file-upload v1.0.0
 * (c) 2017-2017 penyuying
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.layer={})}(this,function(e){"use strict";function t(e,t){if(e){this._el=e;var n={fileTypeExts:"*.jpg;*.png;*.gif;*.jpeg",uploader:"",auto:!0,async:!0,submitUpload:!0,method:"post",multi:!0,formData:null,dataType:"",fileObjName:"file",fileSizeLimit:10240,showUploadedPercent:!0,showUploadedSize:!1,buttonText:"\u9009\u62e9\u6587\u4ef6",compressWidth:1920,compressHeight:1920,compressTotal:0,compressMinSize:100,compressBg:"rgba(0, 0, 0, 0)",encoderOptions:.8,tile:1e6,removeTimeout:1e3,itemTemplate:"",onReaderFile:null,onUploadStart:null,onProgress:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onCompressStart:null,onCompress:null,onSizeError:null,onFileTypeError:null,onInit:null,onCancel:null};(this._options=o(n,t)).el=e,this._init()}}function n(e,t){try{return new Blob(e,{type:t})}catch(i){var n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);return e.forEach(function(e){n.append(e)}),n.getBlob(t)}}function i(){return~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534?new function(){var e=this,t=[],i=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),o=XMLHttpRequest.prototype.send;this.append=function(e,n,o){t.push("--"+i+'\r\nContent-Disposition: form-data; name="'+e+'"'),n instanceof Blob?(t.push('; filename="'+(o||"blob")+'"\r\nContent-Type: '+n.type+"\r\n\r\n"),t.push(n)):t.push("\r\n\r\n"+n),t.push("\r\n")},XMLHttpRequest.prototype.send=function(a){var r=void 0,s=void 0,l=this;a===e?(t.push("--"+i+"--\r\n"),s=n(t),(r=new FileReader).onload=function(){o.call(l,r.result)},r.onerror=function(e){throw e},r.readAsArrayBuffer(s),this.setRequestHeader("Content-Type","multipart/form-data; boundary="+i),XMLHttpRequest.prototype.send=o):o.call(this,a)}}:new FormData}function o(e,t){if(e=e||{},!t)return e;for(var n in t)e[n]instanceof Object?o(e[n],t[n]):e[n]=t[n];return e}function a(e,t){return e=e>1048576&&!t?(Math.round(100*e/1048576)/100).toString()+"MB":(Math.round(100*e/1024)/100).toString()+"KB"}function r(e){for(var t=[],n=e.split(";"),i=0,o=n.length;i<o;i++){var a=n[i].split(".").pop();a&&t.push(a.toLowerCase())}return t}t.prototype={_init:function(){var e=this,t=e._options,n=e._el;e._files=null;var i=e._fileObj=e._addFileBtn(n)||{};i.fileInput&&i.fileInput.addEventListener("change",function(t){e._funGetFiles(t)}),t.onInit&&t.onInit instanceof Function&&t.onInit&&t.onInit(n)},_fileReader:function(e,t){var n=this,i=n._options,o=e.name.split(".").pop();if(!o||n._inArray(o.toLowerCase(),["jpg","jpeg","png","gif","bmp","jpe"])<0||!i.compressMinSize||e.size<=1024*i.compressMinSize)return n._funUploadFile(e,t),e;var a=new FileReader;a.onload=function(){function i(){var i=n._compress(a,e.type,t,e);i=n._toBuffer(i,e.type,e.name),n._funUploadFile(i,t),a=null}var o=this.result,a=new Image;a.src=o,a.complete?i():a.onload=i},a.readAsDataURL(e)},_addFileBtn:function(e){var t=this._options;if(e){var n=function(e){var t=[];if(e&&e.length>0)for(var n=0;n<e.length;n++){var i=function(e){var t="";if(!e)return t;switch(e=(e+"").replace(/\*|\.|\s+/g,"").toLowerCase()){case"3gpp":t="audio/3gpp,video/3gpp";break;case"ac3":t="audio/ac3";break;case"asf":t="allpication/vnd.ms-asf";break;case"au":t="audio/basic";break;case"css":t="text/css";break;case"csv":t="text/csv";break;case"rtf":t="application/rtf,text/rtf";break;case"htm":case"html":t="text/html";break;case"xhtml":t="application/xhtml+xml";break;case"js":t="text/javascript,application/javascript";break;case"txt":t="text/plain";break;case"xml":t="text/xml,application/xml";break;case"dwg":t="image/vnd.dwg";break;case"dxf":t="image/vnd.dxf";break;case"gif":t="image/gif";break;case"jp2":t="image/jp2";break;case"jpe":case"jpeg":case"jpg":t="image/jpeg";break;case"png":t="image/png";break;case"svf":t="image/vnd.svf";break;case"tif":case"tiff":t="image/tiff"}return t}(e[n]);i&&t.push(i)}return t.length<=0?t.push("*"):t.push("image/*"),t}(r(t.fileTypeExts));n=n&&n.join(",")||"*";var i=function(e,t){var n=document.createDocumentFragment(),i=document.createElement("div");n.appendChild(i),i.innerHTML=e;for(var o=i.childNodes||[],a=0;a<o.length;a++)n.appendChild(o[a]);return n.removeChild(i),n}('<div style="display:inline-block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;overflow: hidden;">\n                    <span class="_select-btn-text_" style="display:inline-block;width:100%;line-height:50px;text-align:center;font-size: 12px;color:#999999;">'+t.buttonText+'</span>\n                    <input class="_select-file-btn_"\n                    style="display:block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;font-size: 1000000px;filter: alpha(opacity=0);opacity: 0;"\n                    '+(t.multi?" multiple":"")+'\n                    type="file" name="fileselect" accept="'+n+'">\n                </div>'),o=i.querySelectorAll("input"),a=i.querySelectorAll("div");return e.style.position="relative",e.appendChild(i),{fileInputWrap:a&&a[0]||null,fileInput:o&&o[0]||null}}},_filter:function(e){var t=[],n=this._options,i=r(n.fileTypeExts);if(i.length>0)for(var o=0,s=e.length;o<s;o++){var l=e[o];parseInt(a(l.size,!0))>n.fileSizeLimit?n.onSizeError instanceof Function&&n.onSizeError({el:this._el,index:o,fileName:l.name,file:l,maxSize:a(1024*n.fileSizeLimit||0,!0),size:a(l.size,!0)}):this._inArray(l.name.split(".").pop(),i)>=0?t.push(l):n.onFileTypeError&&n.onFileTypeError instanceof Function&&n.onFileTypeError({el:this._el,index:o,fileName:l.name,file:l,type:l.name.split(".").pop(),typeArray:i})}return t},_inArray:function(e,t){var n=-1;if(!e||!t||t.length<=0)return-1;"string"==typeof e&&(e=e.toLowerCase());for(var i=0;i<t.length;i++){var o=t[i];if("string"==typeof o&&(o=o.toLowerCase()),e==o){n=i;break}}return n},_funGetFiles:function(e){var t=this._options,n=e.target.files;t.onReaderFile instanceof Function&&t.onReaderFile({el:this._el,files:n}),n=this._filter(n),this._files=n,this.submitUpload()},submitUpload:function(){for(var e=this._files,t=this._options,n=0,i=e.length;n<i;n++){var o=e[n];t.auto&&(this._execUpload(o,n),this._files=null)}},_execUpload:function(e,t){var n=this;try{n._fileReader(e,t)}catch(i){n._funUploadFile(e,t)}},_getRatio:function(e,t,n){var i=e/(n.compressWidth>0&&n.compressWidth||e)||0,o=t/(n.compressHeight>0&&n.compressHeight||t)||0,a=Math.sqrt(e*t/(n.compressTotal>0&&n.compressTotal||e*t))||1;return Math.max(Math.max(i,o)||0,a)||1},_compress:function(e,t,n,i){var o=this._options,a=e.src.length,r=e.width,s=r,l=e.height,p=l,c=1,f=0,d=document.createElement("canvas"),u=d.getContext("2d"),h=document.createElement("canvas"),m=h.getContext("2d");(f=this._getRatio(s,p,o))>1&&(r/=c=f,l/=c),o.onCompressStart&&o.onCompressStart instanceof Function&&o.onCompressStart({el:this._el,index:n,file:i,size:a,width:s,height:p,compressWidth:r,compressHeight:l,ratio:c}),d.width=r,d.height=l,u.fillStyle=o.compressBg||"rgba(255, 255, 255, 0)",u.fillRect(0,0,d.width,d.height);var g=void 0;if((g=r*l/(o.tile||1e6))>1){var v=~~(r/(g=~~(Math.sqrt(g)+1))),_=~~(l/g);h.width=v,h.height=_;for(var b=0;b<g;b++)for(var y=0;y<g;y++)m.drawImage(e,b*v*c,y*_*c,v*c,_*c,0,0,v,_),u.drawImage(h,b*v,y*_,v,_)}else u.drawImage(e,0,0,r,l);var x=d.toDataURL(t||"image/png",o.encoderOptions||.6);return o.onCompress&&o.onCompress instanceof Function&&o.onCompress({el:this._el,index:n,file:i,base64Data:x,currentSize:x.length,size:a,ratio:~~(100*(a-x.length)/a)+"%",width:s,height:p,compressWidth:r,compressHeight:l}),h.width=h.height=d.width=d.height=0,x},_toBuffer:function(e,t,i){for(var o=window.atob(e.split(",")[1]),a=new Uint8Array(o.length),r=0;r<o.length;r++)a[r]=o.charCodeAt(r);var s=n([a],t);return s.name=i||"",s},_onProgress:function(e,t,n,i){var o=this._options;o.onProgress&&o.onProgress instanceof Function&&o.onProgress({el:this._el,index:e,file:t,loaded:n,total:i})},_funUploadFile:function(e,t){var n=this,o=function(){var e=void 0;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){e=new ActiveXObject("Microsoft.XMLHTTP")}}return e}()||!1,a=n._options,r=n._fileObj;if(n._files=null,o&&o.upload){o.upload.addEventListener("progress",function(i){n._onProgress(t,e,i.loaded,i.total)},!1),o.onreadystatechange=function(i){if(4==o.readyState){if(200==o.status){var s=o.responseText;"json"==a.dataType&&(s=JSON.parse(o.responseText)),a.onUploadSuccess&&a.onUploadSuccess({el:n._el,file:e,index:t},s)}else a.onUploadError&&a.onUploadError({el:n._el,file:e,index:t},o);a.onUploadComplete&&a.onUploadComplete({el:n._el,file:e,index:t},o),r.fileInput.value=""}},a.onUploadStart&&a.onUploadStart({el:n._el,file:e,index:t,fileName:e.name}),o.open(a.method,a.uploader,a.async||!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest");var s=i();if(e.name?s.append(a.fileObjName,e,e.name):s.append(a.fileObjName,e),a.formData)for(var l in a.formData)s.append(l,a.formData[l]);o.send(s)}}};var s=t;e.FileUpload=s,Object.defineProperty(e,"__esModule",{value:!0})});